import esbuild from 'esbuild';
import process from 'process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const isProduction = process.argv.includes('--production');

// Ruta donde est√° instalado el plugin en el vault
const PLUGIN_INSTALL_PATH = path.join(__dirname, 'vault', '.obsidian', 'plugins', 'gm-vault-exporter-tunnel');

const buildOptions = {
	entryPoints: ['src/main.js'],
	bundle: true,
	format: 'cjs',
	target: 'es2018',
	platform: 'node',
	outfile: 'main.js',
	external: ['obsidian'],
	banner: {
		js: `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`,
	},
	footer: {
		js: `if (module.exports.default) module.exports = module.exports.default;`
	},
	minify: isProduction,
	sourcemap: !isProduction,
	treeShaking: true,
	allowOverwrite: true,
};

// Build
await esbuild.build(buildOptions).catch(() => process.exit(1));

// Copiar archivos al plugin instalado
try {
	// Crear directorio si no existe
	if (!fs.existsSync(PLUGIN_INSTALL_PATH)) {
		fs.mkdirSync(PLUGIN_INSTALL_PATH, { recursive: true });
		console.log(`‚úÖ Creado directorio: ${PLUGIN_INSTALL_PATH}`);
	}

	// Copiar main.js
	const mainJsSource = path.join(__dirname, 'main.js');
	const mainJsDest = path.join(PLUGIN_INSTALL_PATH, 'main.js');
	fs.copyFileSync(mainJsSource, mainJsDest);
	console.log(`‚úÖ Copiado main.js ‚Üí ${mainJsDest}`);

	// Copiar manifest.json
	const manifestSource = path.join(__dirname, 'manifest.json');
	const manifestDest = path.join(PLUGIN_INSTALL_PATH, 'manifest.json');
	fs.copyFileSync(manifestSource, manifestDest);
	console.log(`‚úÖ Copiado manifest.json ‚Üí ${manifestDest}`);

	console.log(`\nüéâ Plugin compilado y copiado exitosamente!`);
	console.log(`üìÅ Ubicaci√≥n: ${PLUGIN_INSTALL_PATH}`);
	console.log(`\nüí° Recarga Obsidian o recarga el plugin para ver los cambios.\n`);
} catch (error) {
	console.error('‚ùå Error al copiar archivos:', error.message);
	process.exit(1);
}

